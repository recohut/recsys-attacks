
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Adversarial Training (Regularization) on a Recommender System &#8212; recsys-attacks</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Black-box Attack on Sequential Recs" href="T355514_Black_box_Attack_on_Sequential_Recs.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">recsys-attacks</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="US026046_Attacks_on_Recommender_Systems.html">
   Attacks on Recommender Systems
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Attack models
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="C361387_DPADL.html">
   DPADL
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C900563_AUSH.html">
   AUSH
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C378133_TAaMR.html">
   TAaMR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C826054_Adversarial.html">
   Adversarial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="C999743_BASR.html">
   BASR
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T006054_SDLib.html">
   SDLib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T865035_Simulating_Data_Poisoning_Attacks_against_Twitter_Recommender.html">
   Simulating Data Poisoning Attacks against Twitter Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T081831_Data_Poisoning_Attacks_on_Factorization_Based_Collaborative_Filtering.html">
   Data Poisoning Attacks on Factorization-Based Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T711285_Data_Poisoning_Attack_using_LFM_and_ItemAE_on_Synthetic_Dataset.html">
   Data Poisoning Attack using LFM and ItemAE on Synthetic Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T697871_Black_box_Attack_API.html">
   Black-box Attack API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T355514_Black_box_Attack_on_Sequential_Recs.html">
   Black-box Attack on Sequential Recs
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Adversarial Training (Regularization) on a Recommender System
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/T102448_Adversarial_Learning_for_Recommendation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/recsys-attacks/main?urlpath=lab/tree/docs/T102448_Adversarial_Learning_for_Recommendation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/sparsh-ai/recsys-attacks/blob/main/docs/T102448_Adversarial_Learning_for_Recommendation.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#global-settings">
   Global settings
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#utils">
   Utils
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluator">
   Evaluator
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data">
   Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dataloader">
     Dataloader
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download">
     Download
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load">
     Load
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model">
   Model
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-the-model">
     Define the model
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initialize-and-train-the-model">
   Initialize and Train The Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-the-model">
   Evaluate The Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#adversarial-attack-against-the-model">
   Adversarial Attack Against The Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-the-effects-of-the-adversarial-attack">
   Evaluate the Effects of the Adversarial Attack
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#implement-the-adversarial-training-regularization">
   Implement The Adversarial Training/Regularization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluated-the-adversarially-defended-model-before-the-attack">
   Evaluated The Adversarially Defended Model before the Attack
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#adversarial-attack-against-the-defended-model">
   Adversarial Attack Against The Defended Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#consequences">
   Consequences
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="adversarial-training-regularization-on-a-recommender-system">
<h1>Adversarial Training (Regularization) on a Recommender System<a class="headerlink" href="#adversarial-training-regularization-on-a-recommender-system" title="Permalink to this headline">¶</a></h1>
<p>Adversarial training (also adversarial regularization) is a defense strategy against adversarial perturbations. The main intuition is to increase the robustness of a recommender system on minimal adversarial perturbation of model parameters by adding further training iterations that takes into account the application of such perturbations.</p>
<p>In this notebook, we become familiar with the usefulness of the adversarial regularization by:</p>
<ul class="simple">
<li><p>Training classical model-based recommender (BPR-MF) on a small part of Movielens-1M</p></li>
<li><p>Attacking the learned model with FGSM-like Adversarial Perturbations</p></li>
<li><p>Adversarially Training the model-based recommender (BPR-MF) with Adversarial Personalized Ranking (APR)</p></li>
<li><p>Attacking the robustified model</p></li>
</ul>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install -q timethis
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span>
<span class="kn">from</span> <span class="nn">timethis</span> <span class="kn">import</span> <span class="n">timethis</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="global-settings">
<h2>Global settings<a class="headerlink" href="#global-settings" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="utils">
<h2>Utils<a class="headerlink" href="#utils" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="c1"># A simple decorator</span>
<span class="k">def</span> <span class="nf">timethis</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="evaluator">
<h2>Evaluator<a class="headerlink" href="#evaluator" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">cpu_count</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>


<span class="n">_feed_dict</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_dataset</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_sess</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_K</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_init_eval_model</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_dataset</span>
    <span class="n">_dataset</span> <span class="o">=</span> <span class="n">data</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">feed_dicts</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_evaluate_input</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">_dataset</span><span class="o">.</span><span class="n">num_users</span><span class="p">))</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">feed_dicts</span>


<span class="k">def</span> <span class="nf">_evaluate_input</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="c1"># generate items_list</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">test_item</span> <span class="o">=</span> <span class="n">_dataset</span><span class="o">.</span><span class="n">test</span><span class="p">[</span><span class="n">user</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">item_input</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">_dataset</span><span class="o">.</span><span class="n">num_items</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">_dataset</span><span class="o">.</span><span class="n">train_list</span><span class="p">[</span><span class="n">user</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">test_item</span> <span class="ow">in</span> <span class="n">item_input</span><span class="p">:</span>
            <span class="n">item_input</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">test_item</span><span class="p">)</span>
        <span class="n">item_input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">item_input</span><span class="p">)</span>
        <span class="n">item_input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_item</span><span class="p">)</span>
        <span class="n">user_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item_input</span><span class="p">),</span> <span class="n">user</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">item_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item_input</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">user_input</span><span class="p">,</span> <span class="n">item_input</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;******&#39;</span> <span class="o">+</span> <span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">_eval_by_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="c1"># get predictions of data in testing set</span>
    <span class="n">user_input</span><span class="p">,</span> <span class="n">item_input</span> <span class="o">=</span> <span class="n">_feed_dicts</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>
    <span class="n">predictions</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_model</span><span class="o">.</span><span class="n">get_inference</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">item_input</span><span class="p">)</span>

    <span class="n">neg_predict</span><span class="p">,</span> <span class="n">pos_predict</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">predictions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">neg_predict</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">pos_predict</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># calculate from HR@1 to HR@100, and from NDCG@1 to NDCG@100, AUC</span>
    <span class="n">hr</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">auc</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_K</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">hr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">ndcg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="n">k</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">auc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">position</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_predict</span><span class="p">)))</span>  <span class="c1"># formula: [#(Xui&gt;Xuj) / #(Items)] = [1 - #(Xui&lt;=Xuj) / #(Items)]</span>

    <span class="k">return</span> <span class="n">hr</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">auc</span>


<span class="k">class</span> <span class="nc">Evaluator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class to manage all the evaluation methods and operation</span>
<span class="sd">        :param data: dataset object</span>
<span class="sd">        :param k: top-k evaluation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_feed_dicts</span> <span class="o">=</span> <span class="n">_init_eval_model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="p">{},</span> <span class="n">epoch_text</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runtime Evaluation of Accuracy Performance (top-k)</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_model</span>
        <span class="k">global</span> <span class="n">_K</span>
        <span class="k">global</span> <span class="n">_dataset</span>
        <span class="k">global</span> <span class="n">_feed_dicts</span>
        <span class="n">_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span>
        <span class="n">_feed_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_feed_dicts</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">num_users</span><span class="p">):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_eval_by_user</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>

        <span class="n">hr</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">auc</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%.3f</span><span class="s2"> Performance@</span><span class="si">%d</span><span class="s2"> </span><span class="se">\t</span><span class="s2">HR: </span><span class="si">%.4f</span><span class="se">\t</span><span class="s2">nDCG: </span><span class="si">%.4f</span><span class="se">\t</span><span class="s2">AUC: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">epoch_text</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">_K</span><span class="p">,</span> <span class="n">hr</span><span class="p">[</span><span class="n">_K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ndcg</span><span class="p">[</span><span class="n">_K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">auc</span><span class="p">[</span><span class="n">_K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">epoch_text</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hr&#39;</span><span class="p">:</span> <span class="n">hr</span><span class="p">,</span> <span class="s1">&#39;ndcg&#39;</span><span class="p">:</span> <span class="n">ndcg</span><span class="p">,</span> <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

    <span class="k">def</span> <span class="nf">store_recommendation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attack_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store recommendation list (top-k) in order to be used for the ranksys framework (sisinflab)</span>
<span class="sd">        attack_name: The name for the attack stored file</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_full_inference</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">_best</span><span class="si">{2}</span><span class="s1">_top</span><span class="si">{3}</span><span class="s1">_rec.tsv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">path_output_rec_result</span><span class="p">,</span>
                                                         <span class="n">attack_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">path_output_rec_result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span>
                                                             <span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">best</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">),</span>
                  <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">results</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_list</span><span class="p">[</span><span class="n">u</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">top_k_id</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">top_k_score</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">top_k_id</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_k_id</span><span class="p">):</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">top_k_score</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runtime Evaluation of Accuracy Performance (top-k)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_model</span>
        <span class="k">global</span> <span class="n">_K</span>
        <span class="k">global</span> <span class="n">_dataset</span>
        <span class="k">global</span> <span class="n">_feed_dicts</span>
        <span class="n">_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span>
        <span class="n">_feed_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_feed_dicts</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">num_users</span><span class="p">):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_eval_by_user</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>

        <span class="n">hr</span><span class="p">,</span> <span class="n">ndcg</span><span class="p">,</span> <span class="n">auc</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performance@</span><span class="si">%d</span><span class="se">\n\t</span><span class="s2">HR: </span><span class="si">%.4f</span><span class="se">\t</span><span class="s2">nDCG: </span><span class="si">%.4f</span><span class="se">\t</span><span class="s2">AUC: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">_K</span><span class="p">,</span> <span class="n">hr</span><span class="p">[</span><span class="n">_K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ndcg</span><span class="p">[</span><span class="n">_K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">auc</span><span class="p">[</span><span class="n">_K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">hr</span><span class="p">[</span><span class="n">_K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ndcg</span><span class="p">[</span><span class="n">_K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">auc</span><span class="p">[</span><span class="n">_K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="data">
<h2>Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h2>
<div class="section" id="dataloader">
<h3>Dataloader<a class="headerlink" href="#dataloader" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">cpu_count</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">dok_matrix</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>


<span class="n">_user_input</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_item_input_pos</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_batch_size</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_index</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_train</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_test</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_num_items</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_train_batch</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generation of a batch in multiprocessing</span>
<span class="sd">    :param i: index to control the batch generayion</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_batch</span><span class="p">,</span> <span class="n">item_pos_batch</span><span class="p">,</span> <span class="n">item_neg_batch</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">_batch_size</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">begin</span> <span class="o">+</span> <span class="n">_batch_size</span><span class="p">):</span>
        <span class="n">user_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_user_input</span><span class="p">[</span><span class="n">_index</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
        <span class="n">item_pos_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_item_input_pos</span><span class="p">[</span><span class="n">_index</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">_num_items</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">_train</span><span class="p">[</span><span class="n">_user_input</span><span class="p">[</span><span class="n">_index</span><span class="p">[</span><span class="n">idx</span><span class="p">]]]:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">_num_items</span><span class="p">)</span>
        <span class="n">item_neg_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">user_batch</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item_pos_batch</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item_neg_batch</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load train and test dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_train_data</span><span class="p">,</span> <span class="n">path_test_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor of DataLoader</span>
<span class="sd">        :param path_train_data: relative path for train file</span>
<span class="sd">        :param path_test_data: relative path for test file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_length</span><span class="p">(</span><span class="n">path_train_data</span><span class="p">,</span> <span class="n">path_test_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_train_file</span><span class="p">(</span><span class="n">path_train_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_train_file_as_list</span><span class="p">(</span><span class="n">path_train_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_test_file</span><span class="p">(</span><span class="n">path_test_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_item_input_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> - Loaded&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_train_data</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> - Loaded&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_test_data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_name</span><span class="p">,</span> <span class="n">test_name</span><span class="p">):</span>
        <span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">train_name</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">test_name</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">train</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]</span>
            <span class="n">test</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">train</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]</span>
            <span class="n">test</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_train_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read /data/dataset_name/train file and Return the matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get number of users and items</span>
        <span class="c1"># self.num_users, self.num_items = 0, 0</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># self.num_users = max(self.num_users, u)</span>
                <span class="c1"># self.num_items = max(self.num_items, i)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Construct URM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">dok_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">rating</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">rating</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># self.num_users = self.train.shape[0]</span>
        <span class="c1"># self.num_items = self.train.shape[1]</span>

    <span class="k">def</span> <span class="nf">load_train_file_as_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="c1"># Get number of users and items</span>
        <span class="n">u_</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_list</span><span class="p">,</span> <span class="n">items</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">u_</span> <span class="o">&lt;</span> <span class="n">u</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">train_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">u_</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_test_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">line</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">user</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">])</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_user_input</span><span class="p">,</span> <span class="n">_item_input_pos</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># positive instance</span>
            <span class="n">_user_input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="n">_item_input_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_user_input</span><span class="p">,</span> <span class="n">_item_input_pos</span>

    <span class="k">def</span> <span class="nf">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shuffle dataset to create batch with batch size</span>
<span class="sd">        Variable are global to be faster!</span>
<span class="sd">        :param batch_size: default 512</span>
<span class="sd">        :return: set of all generated random batches</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_user_input</span>
        <span class="k">global</span> <span class="n">_item_input_pos</span>
        <span class="k">global</span> <span class="n">_batch_size</span>
        <span class="k">global</span> <span class="n">_index</span>
        <span class="k">global</span> <span class="n">_model</span>
        <span class="k">global</span> <span class="n">_train</span>
        <span class="k">global</span> <span class="n">_num_items</span>

        <span class="n">_user_input</span><span class="p">,</span> <span class="n">_item_input_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_item_input_pos</span>
        <span class="n">_batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="n">_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_user_input</span><span class="p">)))</span>
        <span class="n">_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_list</span>
        <span class="n">_num_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span>

        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">_index</span><span class="p">)</span>
        <span class="n">_num_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_user_input</span><span class="p">)</span> <span class="o">//</span> <span class="n">_batch_size</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">())</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_get_train_batch</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">_num_batches</span><span class="p">))</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="n">user_input</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
        <span class="n">item_input_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
        <span class="n">item_input_neg</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">user_input</span><span class="p">,</span> <span class="n">item_input_pos</span><span class="p">,</span> <span class="n">item_input_neg</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="download">
<h3>Download<a class="headerlink" href="#download" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!wget -q --show-progress https://github.com/sisinflab/HandsOn-ECIR2021/raw/master/data/movielens-500/trainingset.tsv
!wget -q --show-progress https://github.com/sisinflab/HandsOn-ECIR2021/raw/master/data/movielens-500/testset.tsv
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>trainingset.tsv.2   100%[===================&gt;]   1.40M  --.-KB/s    in 0.1s    
testset.tsv.2       100%[===================&gt;]   9.83K  --.-KB/s    in 0s      
</pre></div>
</div>
</div>
</div>
<p>First, we will load a short version of Movielens 1M dataset, which has been pre-processed and stored as a TSV file with the following structure: user_id, item_id, rating, timestamp. We have already divided the dataset in training and test sets using the leave-one-out evaluation protocol. We have used a small version with 500 users to reduce the computation time. To execute with the full dataset, you can change ‘movielens-500’ with ‘movielens’.</p>
</div>
<div class="section" id="load">
<h3>Load<a class="headerlink" href="#load" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">path_train_data</span><span class="o">=</span><span class="s1">&#39;trainingset.tsv&#39;</span><span class="p">,</span> <span class="n">path_test_data</span><span class="o">=</span><span class="s1">&#39;testset.tsv&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Statistics:</span><span class="se">\n</span><span class="s1">Number of Users: </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">Number of Items: </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">Training User-Item Ratings: </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">num_users</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">train</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>trainingset.tsv - Loaded
testset.tsv - Loaded

Statistics:
Number of Users: 500
Number of Items: 3172
Training User-Item Ratings: 73371
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="model">
<h2>Model<a class="headerlink" href="#model" title="Permalink to this headline">¶</a></h2>
<div class="section" id="define-the-model">
<h3>Define the model<a class="headerlink" href="#define-the-model" title="Permalink to this headline">¶</a></h3>
<p>We will define a new Tensorflow 2 model class to define the model (BPR-MF). For a matter of simplicity we have also implemented the adversarial attack and defense strategies,, that will be used in the later sections.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RecommenderModel</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class represents a recommender model.</span>
<span class="sd">    You can load a pretrained model by specifying its ckpt path and use it for training/testing purposes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">path_output_rec_result</span><span class="p">,</span> <span class="n">path_output_rec_weight</span><span class="p">,</span> <span class="n">rec</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RecommenderModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec</span> <span class="o">=</span> <span class="n">rec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">num_items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">num_users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_output_rec_result</span> <span class="o">=</span> <span class="n">path_output_rec_result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_output_rec_weight</span> <span class="o">=</span> <span class="n">path_output_rec_weight</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TOPK</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Top-K</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BPRMF</span><span class="p">(</span><span class="n">RecommenderModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">path_output_rec_result</span><span class="p">,</span> <span class="n">path_output_rec_weight</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BPRMF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">path_output_rec_result</span><span class="p">,</span> <span class="n">path_output_rec_weight</span><span class="p">,</span> <span class="s1">&#39;bprmf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_size</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">512</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">Evaluator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">TOPK</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_model_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_perturbations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_optimizer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">initialize_model_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Initialize Model Parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_P</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_users</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_size</span><span class="p">],</span> <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>  <span class="c1"># (users, embedding_size)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_Q</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_size</span><span class="p">],</span> <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>  <span class="c1"># (items, embedding_size)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">initialize_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Optimizer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initialize_perturbations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Set delta variables useful to store delta perturbations,</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_P</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_users</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_size</span><span class="p">]),</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_Q</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_size</span><span class="p">]),</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_inference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_input</span><span class="p">,</span> <span class="n">item_input_pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generate Prediction Matrix with respect to passed users and items identifiers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">embedding_lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_P</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_P</span><span class="p">,</span> <span class="n">user_input</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_q</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">embedding_lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_Q</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_Q</span><span class="p">,</span> <span class="n">item_input_pos</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_p</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_q</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_q</span>  <span class="c1"># (b, embedding_size) * (embedding_size, 1)</span>

    <span class="k">def</span> <span class="nf">get_full_inference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get Full Predictions useful for Full Store of Predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_P</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_P</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_Q</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_Q</span><span class="p">))</span>

    <span class="nd">@timethis</span>
    <span class="k">def</span> <span class="nf">_train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Apply a Single Training Step (across all the batches in the dataset).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_input</span><span class="p">,</span> <span class="n">item_input_pos</span><span class="p">,</span> <span class="n">item_input_neg</span> <span class="o">=</span> <span class="n">batches</span>

        <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_input</span><span class="p">)):</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">watch</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_Q</span><span class="p">])</span>

                <span class="c1"># Model Inference</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_pos</span><span class="p">,</span> <span class="n">embed_p_pos</span><span class="p">,</span> <span class="n">embed_q_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inference</span><span class="p">(</span><span class="n">user_input</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">],</span>
                                                                               <span class="n">item_input_pos</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_neg</span><span class="p">,</span> <span class="n">embed_p_neg</span><span class="p">,</span> <span class="n">embed_q_neg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inference</span><span class="p">(</span><span class="n">user_input</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">],</span>
                                                                               <span class="n">item_input_neg</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_neg</span><span class="p">,</span> <span class="o">-</span><span class="mf">80.0</span><span class="p">,</span> <span class="mf">1e8</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">))</span>

                <span class="c1"># Regularization Component</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reg_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">embed_p_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">embed_q_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">embed_q_neg</span><span class="p">))</span>

                <span class="c1"># Loss Function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loss_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_loss</span>

            <span class="n">gradients</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_opt</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_Q</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_Q</span><span class="p">]))</span>
    
    <span class="nd">@timethis</span>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_train_step</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoch </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">))</span>

    <span class="nd">@timethis</span>
    <span class="k">def</span> <span class="nf">_adversarial_train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Apply a Single Training Step (across all the batches in the dataset).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_input</span><span class="p">,</span> <span class="n">item_input_pos</span><span class="p">,</span> <span class="n">item_input_neg</span> <span class="o">=</span> <span class="n">batches</span>
        <span class="n">adv_reg</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_input</span><span class="p">)):</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">watch</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_Q</span><span class="p">])</span>

                <span class="c1"># Model Inference</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_pos</span><span class="p">,</span> <span class="n">embed_p_pos</span><span class="p">,</span> <span class="n">embed_q_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inference</span><span class="p">(</span><span class="n">user_input</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">],</span>
                                                                               <span class="n">item_input_pos</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_neg</span><span class="p">,</span> <span class="n">embed_p_neg</span><span class="p">,</span> <span class="n">embed_q_neg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inference</span><span class="p">(</span><span class="n">user_input</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">],</span>
                                                                               <span class="n">item_input_neg</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_neg</span><span class="p">,</span> <span class="o">-</span><span class="mf">80.0</span><span class="p">,</span> <span class="mf">1e8</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">))</span>

                <span class="c1"># Regularization Component</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reg_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">embed_p_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">embed_q_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">embed_q_neg</span><span class="p">))</span>

                <span class="c1"># Adversarial Regularization Component</span>
                <span class="c1">##  Execute the Adversarial Attack on the Current Model (Perturb Model Parameters)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execute_adversarial_attack</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>
                <span class="c1">##  Inference on the Adversarial Perturbed Model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_pos_adver</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inference</span><span class="p">(</span><span class="n">user_input</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">],</span> <span class="n">item_input_pos</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_neg_adver</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inference</span><span class="p">(</span><span class="n">user_input</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">],</span> <span class="n">item_input_neg</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">result_adver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_pos_adver</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_neg_adver</span><span class="p">,</span> <span class="o">-</span><span class="mf">80.0</span><span class="p">,</span> <span class="mf">1e8</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loss_adver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">result_adver</span><span class="p">))</span>

                <span class="c1"># Loss Function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adversarial_regularizer</span> <span class="o">=</span> <span class="n">adv_reg</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_adver</span> <span class="c1"># AMF = Adversarial Matrix Factorization</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bprmf_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_loss</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">amf_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bprmf_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">adversarial_regularizer</span>

            <span class="n">gradients</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amf_loss</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_Q</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_Q</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_perturbations</span><span class="p">()</span>


    <span class="nd">@timethis</span>
    <span class="k">def</span> <span class="nf">adversarial_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adversarial_epochs</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">adversarial_epochs</span><span class="p">):</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_adversarial_train_step</span><span class="p">(</span><span class="n">batches</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoch </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="o">+</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="o">+</span><span class="n">adversarial_epochs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">execute_adversarial_attack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
        <span class="n">user_input</span><span class="p">,</span> <span class="n">item_input_pos</span><span class="p">,</span> <span class="n">item_input_neg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_user_input</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_perturbations</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape_adv</span><span class="p">:</span>
            <span class="n">tape_adv</span><span class="o">.</span><span class="n">watch</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_Q</span><span class="p">])</span>
            <span class="c1"># Evaluate Current Model Inference</span>
            <span class="n">output_pos</span><span class="p">,</span> <span class="n">embed_p_pos</span><span class="p">,</span> <span class="n">embed_q_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inference</span><span class="p">(</span><span class="n">user_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                      <span class="n">item_input_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">output_neg</span><span class="p">,</span> <span class="n">embed_p_neg</span><span class="p">,</span> <span class="n">embed_q_neg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inference</span><span class="p">(</span><span class="n">user_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                      <span class="n">item_input_neg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="n">output_pos</span> <span class="o">-</span> <span class="n">output_neg</span><span class="p">,</span> <span class="o">-</span><span class="mf">80.0</span><span class="p">,</span> <span class="mf">1e8</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="n">result</span><span class="p">))</span>
            <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">embed_p_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">embed_q_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">embed_q_neg</span><span class="p">))</span>
        <span class="c1"># Evaluate the Gradient</span>
        <span class="n">grad_P</span><span class="p">,</span> <span class="n">grad_Q</span> <span class="o">=</span> <span class="n">tape_adv</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_Q</span><span class="p">])</span>
        <span class="n">grad_P</span><span class="p">,</span> <span class="n">grad_Q</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">grad_P</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">grad_Q</span><span class="p">)</span>

        <span class="c1"># Use the Gradient to Build the Adversarial Perturbations (https://doi.org/10.1145/3209978.3209981)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_P</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">l2_normalize</span><span class="p">(</span><span class="n">grad_P</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_Q</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">l2_normalize</span><span class="p">(</span><span class="n">grad_Q</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">epsilon</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="initialize-and-train-the-model">
<h2>Initialize and Train The Model<a class="headerlink" href="#initialize-and-train-the-model" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!mkdir -p rec_result rec_weights
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">recommender_model</span> <span class="o">=</span> <span class="n">BPRMF</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;rec_result/&#39;</span><span class="p">,</span> <span class="s1">&#39;rec_weights/&#39;</span><span class="p">)</span>
<span class="n">recommender_model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.111112356185913
Epoch 1/5
2.135735273361206
Epoch 2/5
2.1026523113250732
Epoch 3/5
2.0907275676727295
Epoch 4/5
2.070622682571411
Epoch 5/5
15.236634731292725
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="evaluate-the-model">
<h2>Evaluate The Model<a class="headerlink" href="#evaluate-the-model" title="Permalink to this headline">¶</a></h2>
<p>The evaluation is computed on TOPK recommendation lists (default K = 100).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">before_adv_hr</span><span class="p">,</span> <span class="n">before_adv_ndcg</span><span class="p">,</span> <span class="n">before_adv_auc</span> <span class="o">=</span> <span class="n">recommender_model</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Performance@100
	HR: 0.2760	nDCG: 0.0656	AUC: 0.8229
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="adversarial-attack-against-the-model">
<h2>Adversarial Attack Against The Model<a class="headerlink" href="#adversarial-attack-against-the-model" title="Permalink to this headline">¶</a></h2>
<p>We can attack the model with adversarial perturbation and measure the performance after the attack. Epsilon is the perturbation budget.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running the Attack with Epsilon = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epsilon</span><span class="p">))</span>
<span class="n">recommender_model</span><span class="o">.</span><span class="n">execute_adversarial_attack</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The model has been Adversarially Perturbed.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Running the Attack with Epsilon = 0.5
The model has been Adversarially Perturbed.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="evaluate-the-effects-of-the-adversarial-attack">
<h2>Evaluate the Effects of the Adversarial Attack<a class="headerlink" href="#evaluate-the-effects-of-the-adversarial-attack" title="Permalink to this headline">¶</a></h2>
<p>We will now evaluate the performance of the attacked model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">after_adv_hr</span><span class="p">,</span> <span class="n">after_adv_ndcg</span><span class="p">,</span> <span class="n">after_adv_auc</span> <span class="o">=</span> <span class="n">recommender_model</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;HR decreases by </span><span class="si">%.2f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">after_adv_hr</span><span class="o">/</span><span class="n">before_adv_hr</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nDCG decreases by </span><span class="si">%.2f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">after_adv_ndcg</span><span class="o">/</span><span class="n">before_adv_ndcg</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;AUC decreases by </span><span class="si">%.2f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">after_adv_auc</span><span class="o">/</span><span class="n">before_adv_auc</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Performance@100
	HR: 0.2200	nDCG: 0.0514	AUC: 0.7935
HR decreases by 20.29%
nDCG decreases by 21.58%
AUC decreases by 3.57%
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="implement-the-adversarial-training-regularization">
<h2>Implement The Adversarial Training/Regularization<a class="headerlink" href="#implement-the-adversarial-training-regularization" title="Permalink to this headline">¶</a></h2>
<p>We have identified the clear performance degradation of the recommender under adversarial attack. Now, we can test whether the adversarial regularization will make the model more robust.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">recommender_model</span><span class="o">.</span><span class="n">adversarial_train</span><span class="p">(</span><span class="n">adversarial_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>187.35591626167297
Epoch 6/6
188.3142421245575
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="evaluated-the-adversarially-defended-model-before-the-attack">
<h2>Evaluated The Adversarially Defended Model before the Attack<a class="headerlink" href="#evaluated-the-adversarially-defended-model-before-the-attack" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">before_adv_hr</span><span class="p">,</span> <span class="n">before_adv_ndcg</span><span class="p">,</span> <span class="n">before_adv_auc</span> <span class="o">=</span> <span class="n">recommender_model</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Performance@100
	HR: 0.2920	nDCG: 0.0686	AUC: 0.8336
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="adversarial-attack-against-the-defended-model">
<h2>Adversarial Attack Against The Defended Model<a class="headerlink" href="#adversarial-attack-against-the-defended-model" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">recommender_model</span><span class="o">.</span><span class="n">execute_adversarial_attack</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>##Evaluate the Effects of the Adversarial Attack against the Defended Model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">after_adv_hr</span><span class="p">,</span> <span class="n">after_adv_ndcg</span><span class="p">,</span> <span class="n">after_adv_auc</span> <span class="o">=</span> <span class="n">recommender_model</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;HR decreases by </span><span class="si">%.2f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">after_adv_hr</span><span class="o">/</span><span class="n">before_adv_hr</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nDCG decreases by </span><span class="si">%.2f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">after_adv_ndcg</span><span class="o">/</span><span class="n">before_adv_ndcg</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;AUC decreases by </span><span class="si">%.2f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">after_adv_auc</span><span class="o">/</span><span class="n">before_adv_auc</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Performance@100
	HR: 0.2500	nDCG: 0.0591	AUC: 0.8048
HR decreases by 14.38%
nDCG decreases by 13.80%
AUC decreases by 3.46%
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="consequences">
<h2>Consequences<a class="headerlink" href="#consequences" title="Permalink to this headline">¶</a></h2>
<p>At this point, we have seen that the adversarial training has been effective in reducing the effectiveness of the FGSM-based adversarial attack against the recommender model. Furthermore, we have also identified another important consequences of the adversarial regularization. If we compare the performance of the model before and after the attack we can identify that there has been a performance improvement. For this reason, several recent works have implemented this robustification technique as an additional model component to increase the accuracy power of the recommender model.</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Steffen Rendle, Christoph Freudenthaler, Zeno Gantner, Lars Schmidt-Thieme: BPR: Bayesian Personalized Ranking from Implicit Feedback. UAI 2009: 452-461</p></li>
<li><p>Xiangnan He, Zhankui He, Xiaoyu Du, Tat-Seng Chua: Adversarial Personalized Ranking for Recommendation. SIGIR 2018: 355-364</p></li>
<li><p><a class="reference external" href="https://github.com/merrafelice/HandsOn-RecSys2020">https://github.com/merrafelice/HandsOn-RecSys2020</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "sparsh-ai/recsys-attacks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T355514_Black_box_Attack_on_Sequential_Recs.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Black-box Attack on Sequential Recs</p>
            </div>
        </a>
    </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>